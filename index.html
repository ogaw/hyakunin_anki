<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>百人一首 決まり字 練習</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; margin: 0; padding: 16px; }
    .wrap { max-width: 980px; margin: 0 auto; display: grid; gap: 12px; }
    .card { border: 1px solid rgba(127,127,127,.35); border-radius: 12px; padding: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .imgbox { display: grid; place-items: center; min-height: 240px; }
    img.main { max-width: 100%; height: auto; border-radius: 10px; border: 1px solid rgba(127,127,127,.25); }
    input[type="text"] { width: min(420px, 100%); padding: 10px 12px; font-size: 16px; border-radius: 10px; border: 1px solid rgba(127,127,127,.35); }
    button { padding: 10px 12px; font-size: 14px; border-radius: 10px; border: 1px solid rgba(127,127,127,.35); background: transparent; cursor: pointer; }
    button:hover { filter: brightness(1.06); }
    .status { white-space: pre-wrap; line-height: 1.5; }
    .status .headline { font-size: 2em; font-weight: 900; }
    .status .info { margin-top: 6px; white-space: pre-wrap; }
    .timer { font-size: 18px; font-weight: 700; }
    .timer.over { color: #d00; } /* 10秒超え */
    .ok { color: #1f6feb; font-weight: 800; }
    .bad { color: #d1242f; font-weight: 800; }
    .muted { opacity: .8; }
    .small { font-size: 12px; opacity: .8; }

    /* wrong list */
    .wrong-row { display:flex; gap:10px; align-items:center; padding:8px 0; border-top:1px solid rgba(127,127,127,.2); }
    .wrong-row img { width: 140px; height:auto; border-radius:8px; border:1px solid rgba(127,127,127,.25); }
    .wrong-meta { min-width:0; }
    .wrong-meta .no {  font-size: 16px;  font-weight:800; }
    .wrong-meta .kim { font-weight:800; }
    .wrong-meta .time { font-size: 16px; }
    .wrong-meta .waka { font-size: 20px; }
    .wrong-meta .full { font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content: space-between;">
        <div>
          <div style="font-weight:800;">百人一首 決まり字 練習</div>
          <div class="small muted">Enter＝判定／（正解後）次へ　 Esc＝答えを見る　 リセット＝シャッフルして最初から</div>
        </div>
        <div class="small muted" id="meta"></div>
      </div>
    </div>

    <div class="card">
      <div class="imgbox">
        <img class="main" id="cardImg" alt="取札" />
      </div>
      <div class="small muted" id="imgHint"></div>
    </div>

    <div class="card">
      <div class="row">
        <label for="answerInput" class="muted">決まり字：</label>
        <input id="answerInput" type="text" autocomplete="off" placeholder="例：あきの" />
      </div>
      <div id="timer" class="timer">0.00s</div>

      <div class="row" style="margin-top: 10px;">
        <button id="btnReset" type="button">リセット</button>
        <button id="btnShow" type="button">答えを見る</button>
        <button id="btnCheck" type="button">答える</button>
        <button id="btnNext" type="button">次の問題</button>
      </div>

      <div style="margin-top: 10px;" class="status" id="status"></div>
    </div>

    <div class="card">
      <div style="font-weight:800; margin-bottom:8px;">この一巡で間違えた札</div>
      <div id="wrongArea" class="muted small">（まだありません）</div>
    </div>
  </div>

  <!-- 100首データ -->
  <script src="cards.js"></script>

  <script>
    /***********************
     * 画像パス（あなたの形式）
     ***********************/
    function imgName(n) {
      const s = String(n).padStart(3, "0");
      return `fuda/f1s1_${s}.jpg`;
    }

    /***********************
     * 状態
     ***********************/
    let currentIndex = 1;
    let deck = [];
    let deckPos = 0;
    

    // --- 周回（間違いだけ繰り返す） ---
    let roundNo = 1;
    let totalThisRound = 100;
    let wrongRound = new Set();   // 現周回で間違えた札（次周回へ）

    // --- タイマー ---
    const TIMEOUT_SEC = 10.0;     // 10秒以上は不正解扱い（次周回へ残す）
    let questionStartMs = 0;      // performance.now()
    let lastResult = "none"; // "none" | "ok" | "ng" | "shown" | "done"
    let wrongSet = new Set();

    /***********************
     * DOM
     ***********************/
    const elImg = document.getElementById("cardImg");
    const elInput = document.getElementById("answerInput");
    const elStatus = document.getElementById("status");
    const elMeta = document.getElementById("meta");
    const elImgHint = document.getElementById("imgHint");
    const elWrong = document.getElementById("wrongArea");

    const btnReset = document.getElementById("btnReset");
    const btnShow = document.getElementById("btnShow");
    const btnCheck = document.getElementById("btnCheck");
    const btnNext = document.getElementById("btnNext");

    /***********************
     * ユーティリティ
     ***********************/
    function normalize(s) {
      return (s ?? "").trim().replace(/\u3000/g, "");
    }

    // --- ゆれ許容（B案：集合展開方式） ---
    // ※canon() は比較用の正規化。必要ならここに追加してOK（例：カタカナ→ひらがな等）
    function canon(s) {
      return normalize(s);
    }

    const FUZZY_PAIRS = [
      ["わ", "は"],
      ["い", "ひ"],
      ["ゐ", "い"],
      ["ふ", "う"],
      ["ゑ", "え"],
      ["え", "へ"],
      ["ほ", "お"],
      ["お", "を"],
      ["む", "ん"],
    ];

    function expandSet(s) {
      let set = new Set([canon(s)]);

      for (const [a, b] of FUZZY_PAIRS) {
        const next = new Set(set);
        for (const v of set) {
          if (v.includes(a) || v.includes(b)) {
            next.add(v.split(a).join(b)); // replaceAll互換（古いブラウザ対策）
            next.add(v.split(b).join(a));
          }
        }
        set = next;
      }
      return [...set];
    }


    function getCard(n = currentIndex) {
      return CARD_BY_NO.get(n) ?? null;
    }

    function getCorrect(n = currentIndex) {
      return getCard(n)?.kimariji ?? "";
    }

    function setStatus(msg, kind = "") {
      elStatus.className = "status " + kind;
      elStatus.textContent = msg;
    }

    function setStatusHTML(html, kind = "") {
      elStatus.className = "status " + kind;
      elStatus.innerHTML = html;
    }

    function makeDeckShuffled(arrOpt = null) {
        deck = arrOpt ? arrOpt.slice() : Array.from({ length: 100 }, (_, i) => i + 1);
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
        deckPos = 0;
        totalThisRound = deck.length;
        wrongRound = new Set();
    }

    function nextFromDeck() {
      if (deckPos >= deck.length) return null; // 一巡終了
      const n = deck[deckPos];
      deckPos++;
      return n;
    }

    function clearWrongArea() {
      elWrong.textContent = "（まだありません）";
    }

    const wrongInfo = new Map(); // key: no, value: { timeSec, timedOut, ... }

    function renderWrongList() {
      const wrongs = Array.from(wrongSet.values()).sort((a, b) => a - b);

      if (wrongs.length === 0) {
        elWrong.innerHTML = '<div class="ok">全問正解！</div>';
        return;
      }

      elWrong.innerHTML = wrongs.map((n) => {
        const c = getCard(n);
        const no = String(n).padStart(3, "0");
        const kim = c?.kimariji ?? "";
        const info = wrongInfo.get(n);
        const t = info ? info.timeSec : null;
        const waka = c.poem;
        const full = c.yomi_kami + "　" + c.yomi_shimo;
        const timedOut = info?.timedOut;
        const timeStr = (t != null)
          ? `<span class="${timedOut ? "over10" : ""}">${t.toFixed(2)}s</span>`
          : "";

        return `
          <div class="wrong-row">
            <img src="${imgName(n)}" alt="No.${no}">
            <div class="wrong-meta">
              <div>
              <span class="no">No.${no}</span>
              <span class="small muted">${c?.author ?? ""}</span></div>
              <div>時間：<span class="time">${timeStr}</span></div>
              <div>決まり字：<span class="kim">${kim}</span>（${c?.klen ?? "?"}字）</div>
              <div class="waka">${waka}</div>
              <div></div>
              <div class="full">${full}</div>
            </div>
          </div>
        `;
      }).join("");
    }
    
    const elTimer = document.getElementById("timer");

    let timerRunning = false;
    let timerRaf = 0;

    function fmtSec(sec) {
      return `${sec.toFixed(2)}s`;
    }

    function getElapsedSecNow() {
      return (performance.now() - questionStartMs) / 1000;
    }

    function startTimer() {
      timerRunning = true;
      cancelAnimationFrame(timerRaf);

      const tick = () => {
        if (!timerRunning) return;
        const sec = getElapsedSecNow();
        elTimer.textContent = fmtSec(sec);
        elTimer.classList.toggle("over", sec >= TIMEOUT_SEC);
        timerRaf = requestAnimationFrame(tick);
      };
      tick();
    }

    function stopTimer() {
      timerRunning = false;
      cancelAnimationFrame(timerRaf);
      const sec = getElapsedSecNow();
      elTimer.textContent = fmtSec(sec);
      elTimer.classList.toggle("over", sec >= TIMEOUT_SEC);
      return sec;
    }    

    /***********************
     * 画面更新
     ***********************/
    function loadCard(n) {
      currentIndex = n;
      lastResult = "none";

      // タイマー開始
      questionStartMs = performance.now();
      startTimer();

      elInput.value = "";
      setStatus("");
      
      {
           const c = getCard(n);
           const klen = c?.klen ?? "?";

           elInput.placeholder = `決まり字（${klen}字）`;
           elMeta.textContent = `No.${String(n).padStart(3, "0")}  決まり字数:${klen} (${deckPos}/${totalThisRound})`;
      }
      
      elImg.src = imgName(n);
      elImg.onerror = () => {
        setStatus(
          "画像が読み込めない。\n" +
          "・fuda/f1s1_001.jpg? が置けているか確認\n" +
          "・file:// 制限が出るなら簡易サーバで開く（例: python -m http.server）",
          "bad"
        );
      };

      elInput.focus();
    }

    function finishRound() {
        if (wrongRound.size === 0) {
            lastResult = "done";
            setStatus(`完了：第${roundNo}巡で全問正解`, "ok");
            renderWrongList();
            alert(`${roundNo}巡目で全問正解しました！`);
            return;
        }

        // 次周回：この周回で間違えた札だけ（正解するまで残る）
        roundNo += 1;
        wrongSet = new Set(wrongRound); // 「残り」表示用
        renderWrongList();

        makeDeckShuffled(Array.from(wrongRound));
        //setStatus(`第${roundNo}巡を開始（残り ${totalThisRound} 問）`, "muted");
        const n = nextFromDeck();

        alert(`${roundNo}巡目を開始します`);

        loadCard(n);
    }



    function goNext() {
      const n = nextFromDeck();
      if (n === null) finishRound();
      else loadCard(n);
    }

    function startNewRound() {
        roundNo = 1;
        wrongSet = new Set();   // 「残り」表示用
        wrongRound = new Set(); // 現周回の間違い

        clearWrongArea();
        setStatus("第1巡を開始。", "muted");

        makeDeckShuffled(); 
        const n = nextFromDeck();
        if (n === null) 
            finishRound();
        else 
            loadCard(n);
    }

    function showAnswer() {
      const correct = getCorrect();
      if (!correct) {
        setStatus("データが見つからない（cards.js を確認）", "bad");
        lastResult = "ng";
        return;
      }

      lastResult = "shown";
      setStatus(`答え：${correct}`, "");

      // 回答時間（秒、小数第2位まで）
      const elapsedSec = stopTimer();
      const timedOut = elapsedSec >= TIMEOUT_SEC;

        wrongInfo.set(currentIndex, {
              timeSec: elapsedSec,
              timedOut,
        });
        wrongSet.add(currentIndex);
        wrongRound.add(currentIndex);
        renderWrongList(); // 都度更新
        const c = getCard();
        const no = String(currentIndex).padStart(3, "0");
        setStatusHTML(
          `<div class="headline bad">正解：${correct}</div>
           <div class="info">
No.${no}
作者：${c?.author ?? ""}
読み札：${c?.poem ?? ""}
決まり字：${correct}
           </div>`,
          ""
        );
        lastResult = "ng";

    }

    function checkAnswer() {
      const correct = normalize(getCorrect());
      if (!correct) {
        setStatus("データが見つからない（cards.js を確認）", "bad");
        lastResult = "ng";
        return;
      }

      const user = normalize(elInput.value);
      if (!user) {
        setStatus("未入力。決まり字を入れてEnter", "bad");
        lastResult = "error";
        return;
      }
      
      
      const uSet = expandSet(elInput.value);
      const kSet = expandSet(getCorrect());

      // 決まり字は短いので「どれかで始まればOK」
      //const isOk = kSet.some(k => uSet.some(u => u.startsWith(k)));
      let isOk = false;
      outer:
      for (const k of kSet) {
        for (const u of uSet) {
          if (u.startsWith(k)) {
            isOk = true;
            break outer; // 2重ループを一発で抜ける
          }
        }
      }
      
      // 回答時間（秒、小数第2位まで）
      const elapsedSec = stopTimer();
      const timedOut = elapsedSec >= TIMEOUT_SEC;

      if (isOk) {
        if(timedOut) {
            wrongInfo.set(currentIndex, {
                  timeSec: elapsedSec,
                  timedOut,
            });
            wrongSet.add(currentIndex);
            wrongRound.add(currentIndex);
            renderWrongList(); // 都度更新

            const c = getCard();
            const no = String(currentIndex).padStart(3, "0");
            setStatusHTML(
            `<div class="headline ok">正解！ だけど遅かったので苦手札として次巡に残ります。</div>
             <div class="info">
No.${no}
作者：${c?.author ?? ""}
読み札：${c?.poem ?? ""}
決まり字：${correct}
             </div>`,
            ""
        );
           lastResult = "ok";
        } else {
            const c = getCard();
            const no = String(currentIndex).padStart(3, "0");
            setStatusHTML(
          `<div class="headline ok">正解！</div>
           <div class="info">
No.${no}
作者：${c?.author ?? ""}
読み札：${c?.poem ?? ""}
決まり字：${correct}
           </div>`,
          ""
          );
          lastResult = "ok";

          // 2巡目以降：正解した札は「残り」から外す
          if (roundNo > 1 && wrongSet.has(currentIndex)) {
            wrongSet.delete(currentIndex);
            renderWrongList();
          }
        }
      } else {
        wrongInfo.set(currentIndex, {
              timeSec: elapsedSec,
              timedOut,
        });
        wrongSet.add(currentIndex);
        wrongRound.add(currentIndex);
        renderWrongList(); // 都度更新
        const c = getCard();
        const no = String(currentIndex).padStart(3, "0");
        setStatusHTML(
          `<div class="headline bad">不正解！　正解：${correct}</div>
           <div class="info">
No.${no}
作者：${c?.author ?? ""}
読み札：${c?.poem ?? ""}
決まり字：${correct}
           </div>`,
          ""
        );
        lastResult = "ng";
      }
    }

    /***********************
     * イベント
     ***********************/
    btnReset.addEventListener("click", () => {
      if (!confirm("リセットして最初からやり直しますか？")) return;
      startNewRound();
    });
    
    
    btnShow.addEventListener("click", () => {
      // 不正解表示中は「答えを見る」＝次へ（連打で暗記確認できる）
      if (lastResult === "ok" || lastResult === "ng" || lastResult === "shown") goNext();
      else showAnswer();
    });
    btnCheck.addEventListener("click", () => {
      if (lastResult === "ok" || lastResult === "ng" || lastResult === "shown") goNext();
      else checkAnswer();
    });

    btnNext.addEventListener("click", () => {
      goNext();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        if (lastResult === "ok" || lastResult === "ng" || lastResult === "shown") goNext();
        else checkAnswer();
      } else if (e.key === "Escape") {
        e.preventDefault();
        if (lastResult === "ok" || lastResult === "ng" || lastResult === "shown") goNext();
        else showAnswer();
      }
    });

    /***********************
     * 起動
     ***********************/
    // cards.js が読み込めているか最低限チェック
    if (typeof CARDS === "undefined" || CARDS.length !== 100) {
      setStatus("cards.js が読み込めていない / 100首になっていない。index.html と同じ場所に cards.js を置いてね。", "bad");
    } else {
      startNewRound();
    }
  </script>
</body>
</html>
